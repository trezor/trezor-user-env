image: $CI_DEPENDENCY_PROXY_DIRECT_GROUP_IMAGE_PREFIX/nixos/nix:2.3.12

test:
  stage: test
  needs: []
  variables:
    SDL_VIDEODRIVER: "dummy"
  script:
    - nix-shell --run "./src/binaries/firmware/bin/download.sh && ./src/binaries/trezord-go/bin/download.sh"
    - nix-shell --run "poetry install"
    - nix-shell --run "poetry run make test"
  after_script:
    - cp /builds/satoshilabs/trezor/trezor-user-env/logs/debugging.log trezor-user-env-debugging.log
    - cp /builds/satoshilabs/trezor/trezor-user-env/logs/emulator_bridge.log tenv-emulator-bridge-debugging.log
  artifacts:
    paths:
      - trezor-user-env-debugging.log
      - tenv-emulator-bridge-debugging.log
    expire_in: 1 week
    when: always
