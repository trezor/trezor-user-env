# Start with a base Debian image
FROM debian:trixie-slim

# Set environment variables
ENV TERM=xterm \
    XDG_RUNTIME_DIR="/var/tmp" \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    GIT_SSL_CAINFO=/etc/ssl/certs/ca-certificates.crt \
    NIX_SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt

# Install required packages
RUN curl -sL https://deb.nodesource.com/setup_22.x  | bash -
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssl \
    bash \
    git \
    nodejs \
    python3 \
    python3-dev \
    python3-pip \
    python3-venv \
    libsdl2-2.0-0 \
    libsdl2-image-2.0-0 \
    x11-xserver-utils \
    wget \
    unzip \
    curl \
    procps \
    build-essential \
    g++ \
    libc6 \
    libc6-dev \
    patchelf \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install uv for package management
COPY --from=ghcr.io/astral-sh/uv:0.8.20 /uv /uvx /bin/

# Copy project configuration files
WORKDIR /trezor-user-env
COPY ./pyproject.toml /trezor-user-env/
COPY ./uv.lock /trezor-user-env/
COPY ./.python-version /trezor-user-env/

# Install dependencies with uv (it will create .venv automatically)
RUN uv sync

# Copy the rest of the files
COPY ./ /trezor-user-env

# Cache-bust downloads when inputs change
ARG CACHE_BUST=1
RUN ./src/binaries/firmware/bin/download.sh
RUN ./src/binaries/trezord-go/bin/download.sh
RUN ./src/binaries/node-bridge/download.sh
# Patch emulator binaries
RUN cd src/binaries/firmware/bin && ./patch-bin.sh

# Command to run on container start
CMD ["uv", "run", "python", "src/main.py"]
